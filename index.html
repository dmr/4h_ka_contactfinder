<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Contact Finder</title>

    <meta name="description" content="Trip is a collaboration tool for teams.">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style"
          content="default" /> <!-- default, black and black-translucent -->

    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0" />

    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.0/css/font-awesome.css" rel="stylesheet">

    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.3.js"></script>
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.0.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>

    <style>
        li { background: #f0f0f0; padding: 5px;}
        li:nth-child(odd) { background: #fff; }
    </style>

</head><body>


<script id="login" type="text/html">
    <div id="wrap">
        <div class="container">
            <div class="page-header">
                <h1>ContactViewer</h1>
            </div>

            <h2>
                A login is required.<br />
            </h2>
            <p>
                Please login @ <a href="https://trip-app.com/">Trip-App.com</a> and come back afterwards :)
            </p>
        </div>
        <div id="push"></div>
    </div>

    <div id="footer">
        <div class="container">
            <p class="muted credit">Contact Finder is a <a href="http://twitter.com/#4hventureka">4h venture KA</a> project.</p>
        </div>
    </div>


</script>
<script id="contactViewerTmpl" type="text/html">
    <div id="wrap">
        <div class="container">
            <div class="navbar">
                <div class="navbar-inner">
                    <a class="brand" href="#">ContactViewer</a>
                    <div class="nav">
                        <form class="navbar-search pull-left">
                        <input type="text" class="search-query" placeholder="Search" data-bind="value: query, valueUpdate: 'keyup'">
                        </form>
                    </div>
                </div>
            </div>

            <!-- ko ifnot: users().length -->
            <div>Loading...</div>
            <!-- /ko -->

            <!-- ko if: users -->
            <ul class="media-list" data-bind="foreach: filtered_users">
                <li class="media">
                    <a class="pull-left" href="#">
                        <img class="media-object" width="64" height="64"
                             data-bind="attr: {'src': 'https://trip-app.com'+avatar}" />
                    </a>
                    <div class="media-body">
                        <h4 class="media-heading">
                            <span data-bind="text: first_name"></span>&nbsp;<span data-bind="text: last_name"></span>
                        </h4>
                        <!-- ko if: email --><div data-bind="text: email"></div><!-- /ko -->
                        <!-- ko if: mobile --><div data-bind="text: mobile"></div><!-- /ko -->
                        <!-- ko if: skype --><div data-bind="text: skype"></div><!-- /ko -->
                        <!-- ko if: phone --><div data-bind="text: phone"></div><!-- /ko -->
                        <!-- ko if: twitter --><div data-bind="text: twitter"></div><!-- /ko -->
                        <!-- ko if: web --><div><a data-bind="attr: {href: web}, text: web"></a></div><!-- /ko -->
                    </div>
                </li>
            </ul>
            <!-- /ko -->
        </div>
        <div id="push"></div>
    </div>

    <div id="footer">
        <div class="container">
            <p class="muted credit">Contact Finder is a <a href="http://twitter.com/#4hventureka">4h venture KA</a> project.</p>
        </div>
    </div>
</script>


<!-- ko if: tmpl -->
<!-- ko template: tmpl -->
<!-- /ko -->
<!-- /ko -->


<script type="text/javascript">
    function ContactViewerTmpl(backend) {
        var self = this;

        self.users = ko.observableArray();

        self.query = ko.observable();
        self.query.subscribe(function() {
        });

        self.filtered_users = ko.computed(function() {
            if(self.query()) {
                var filter = self.query().toLowerCase();
                return ko.utils.arrayFilter(self.users(), function(item) {
                    return item.first_name.toLowerCase().indexOf(filter) != -1;
                });
            } else {
                return self.users();
            }
        });

        backend.get_user_list()
        .done(function(resp) {
            self.users(resp);
            /*ko.utils.arrayForEach(resp, function(user) {
                if (user.fax) {
                    console.log(user.email, user.fax);
                }
            });*/
        });
    }


    function Backend() {
        var api_base_url = 'https://trip-app.com/api/';

        var do_request = function(method, url, data) {
            var params = {
                url: api_base_url+url,
                data: data,
                dataType: "json",
                type: method,
                crossDomain: true,
                xhrFields:{
                    withCredentials:true
                }
            };
            return $.ajax(params);
        };
        var do_get = do_request.bind({}, "get");

        var self = this;
        $.extend(self, {
            get_username: function() {
                return do_get('_session/');
            },

            get_user_list: function() {
                return do_get('user/');
            },
            get_network_list: function() {
                return do_get('network/');
            },
            get_group_list: function() {
                return do_get('group/');
            },

            search: function(query_str) {
                return do_get('search/', {'q':query_str});
            }
        });

        self.init = function() {
            self.tokenXhr = $.get(api_base_url+'_token/', {async:false})
            .done(function(resp) {
                var CSRF_TOKEN_FROM_SERVER = resp.token;

                var setCookie = function(c_name, value, exdays) {
                    var exdate=new Date();
                    exdate.setDate(exdate.getDate() + exdays);
                    document.cookie = c_name + "=" + value +
                            "; expires="+exdate.toUTCString() + "; path=/";
                };

                // TODO: change handling, but it works for now...
                // http://www.djangoproject.com/weblog/2011/feb/08/security/
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", CSRF_TOKEN_FROM_SERVER);
                    }
                });
                setCookie("csrftoken", CSRF_TOKEN_FROM_SERVER, 5);
            });
        };
    }

    function ViewModel(backend) {
        var self = this;

        self.tmpl = ko.observable();
        self.logged_in_username = ko.observable();

        backend.get_username()
        .done(function(resp) {
            self.logged_in_username(resp.username);
            self.tmpl({
                name: 'contactViewerTmpl',
                data: new ContactViewerTmpl(backend)
            });
        }).error(function(resp) {
            if (resp.status == 401) { // "UNAUTHORIZED"
                self.tmpl({
                    name: 'login',
                    data: {}
                });
            }
        });
    }

    var VM = null;
    $(document).ready(function() {
        var backend = new Backend();
        backend.init();
        var viewModel = new ViewModel(backend);
        ko.applyBindings(viewModel);
        VM = viewModel;
    });
</script>

</body></html>
